# VCU Driver Profile Tool
A cross-platform graphical tool for customising and exporting driver profiles for the VCU throttle response.

<p align="center">
  <img src="./docs/C2 Spline.png" width="90%" class="center">
</p>

## TODO: Installing
This tool has been compiled for macOS and Windows as a standalone application. The latest releases are available [here](https://github.com/sufst/vcu-driver-profile/releases), or click the links below for a download:

- [macOS](todo)
- [Windows](todo)

The program can also be compiled and run on Linux using `make` and the JUCE project configuration tool (see: [contributing](#contributing)).

## TODO: Creating a Profile

Tips for getting a good profile:
- Make sure the curve is strictly increasing.
- Make sure the curve doesn't exceed the axis bounds - this will cause clipping when the profile is exported.
- Don't place points next to each other with a steep gradient between them - this causes poor interpolation.
- Make sure no two points have the same input (x-axis) coordinate - you can't map one input to two different outputs. Interpolation algorithms also don't like this because the curve becomes discontinuous (or has an infinite gradient).

A warning will be generated when exporting if there is a major issue with the generated curve.

## Interpolation Algorithms

<p align="center">
  <img src="./docs/Linear.png" width="45%" class="center">
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  <img src="./docs/C2 Spline.png" width="45%" class="center">
</p>

Four algorithms are available for [interpolating](http://paulbourke.net/miscellaneous/interpolation/) between the placed points which can be selected from the drop-down list.
1.  Linear (simplest)
2.  Cosine (useless)
3.  C2 spline (best)
4.  Hermite spline (good)

## Throttle 'Dead-Zone'
The blue region at the left of the curve defines the 'dead-zone' for the throttle. An input in this region will produce no output torque from the motor. A small dead-zone is required to guarantee that the car will not move when the throttle is fully released as slight mechanical misalignments or voltage measurement errors may still produce a small input to the VCU.

<p align="center">
  <img src="./docs/Deadzone.gif" width="50%" class="center">
</p>

## Importing and Exporting Profiles
Created profiles can be exported to an XML document by pressing the 'export profile' button and choosing a location on your computer to save the file. These files can be imported again and edited further by pressing the 'import profile' button, or by dragging the file into the graph area. The placed points the chosen interpolation method are stored in these documents, but not every point on the interpolated curve as these easily can be re-generated by importing the placed points. The deadzone is defined by the value of the first point and does not need to be stored separately.

<p align="center">
  <img src="./docs/Profile.gif" width="60%" class="center">
</p>

## Exporting Source Code
The 'export code' button will generate a `uint16_t` C array mapping 2ยนโฐ integer input values onto the interpolated curve and copy it to the clipboard. This is used as a look-up table in the VCU to map the scaled 10-bit analogue reading from the throttle to the desired output torque.

```C
static const uint16_t driver_profile [1024] = {
  0x0000, 0x002e, 0x005d, 0x008b, 0x00ba, 0x00e9, 0x0117, 0x0146, 
  0x0174, 0x01a3, 0x01d2, 0x0200, 0x022f, 0x025d, 0x028c, 0x02bb, 
  0x02e9, 0x0318, 0x0346, 0x0375, 0x03a3, 0x03d2, 0x0400, 0x042f, 
  0x045d, 0x048c, 0x04ba, 0x04e8, 0x0517, 0x0545, 0x0574, 0x05a2, 
  // ...
};
```

## Contributing
Clone the repo:
```
git clone https://github.com/sufst/vcu-driver-profile
```
Clone / update submodules:
```
git submodule init
git submodule update
```

Install [JUCE](https://juce.com/get-juce) (personal or education) on your system. [JUCE's project configuration tool](https://juce.com/discover/projucer) will generate the necessary project files to build, run and debug a project using a variety of exporters (usually an IDE).
- For macOS, use Xcode.
- For Windows use Visual Studio (untested).
- For Linux use make.

## Dependencies
- [JUCE](https://github.com/juce-framework/JUCE)
- [Spline](https://github.com/ttk592/spline)
